# Infrastructure Deployment Pipeline
# Deploy Azure infrastructure for Pathfinder using Bicep
name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force redeploy infrastructure'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/**'
      - 'scripts/deploy-single-rg.sh'

env:
  AZURE_RESOURCE_GROUP: pathfinder-rg
  AZURE_LOCATION: eastus
  APP_NAME: pathfinder

jobs:
  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Validate Bicep template
        run: |
          echo "🔍 Validating Bicep template..."
          az deployment group validate \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infrastructure/bicep/pathfinder-single-rg.bicep \
            --parameters \
              appName="${{ env.APP_NAME }}" \
              location="${{ env.AZURE_LOCATION }}" \
              sqlAdminLogin="${{ secrets.SQL_ADMIN_USERNAME }}" \
              sqlAdminPassword="${{ secrets.SQL_ADMIN_PASSWORD }}" \
              openAIApiKey="${{ secrets.OPENAI_API_KEY }}" \
            --output table
          
          echo "✅ Template validation passed"

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-infrastructure]
    if: github.ref == 'refs/heads/main' || github.event.inputs.force_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Create resource group if needed
        run: |
          echo "🏗️ Ensuring resource group exists..."
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags \
              app=${{ env.APP_NAME }} \
              architecture=cost-optimized-single-rg \
              deploymentType=solo-developer \
              managementStrategy=unified \
              costOptimization=enabled \
            --output table
      
      - name: Deploy infrastructure
        run: |
          echo "🚀 Deploying infrastructure to ${{ env.AZURE_RESOURCE_GROUP }}..."
          
          DEPLOYMENT_NAME="pathfinder-infra-$(date +%Y%m%d-%H%M%S)"
          
          az deployment group create \
            --name "$DEPLOYMENT_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infrastructure/bicep/pathfinder-single-rg.bicep \
            --parameters \
              appName="${{ env.APP_NAME }}" \
              location="${{ env.AZURE_LOCATION }}" \
              sqlAdminLogin="${{ secrets.SQL_ADMIN_USERNAME }}" \
              sqlAdminPassword="${{ secrets.SQL_ADMIN_PASSWORD }}" \
              openAIApiKey="${{ secrets.OPENAI_API_KEY }}" \
            --mode Incremental \
            --output table
          
          echo "✅ Infrastructure deployment complete"
      
      - name: Verify deployment
        run: |
          echo "🔍 Verifying infrastructure deployment..."
          
          # Check key resources
          echo "Checking Container Apps Environment..."
          az containerapp env show \
            --name pathfinder-env \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output table
          
          echo "Checking SQL Server..."
          az sql server list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output table
          
          echo "Checking Key Vault..."
          az keyvault list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output table
          
          echo "✅ Infrastructure verification complete"
      
      - name: Output deployment summary
        run: |
          echo "## 🏗️ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Location**: ${{ env.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Single Resource Group Cost Optimization" >> $GITHUB_STEP_SUMMARY
          echo "- **Template**: pathfinder-single-rg.bicep" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 💰 Cost Benefits" >> $GITHUB_STEP_SUMMARY
          echo "- Single resource group for unified management" >> $GITHUB_STEP_SUMMARY
          echo "- Scale-to-zero container apps" >> $GITHUB_STEP_SUMMARY
          echo "- Serverless Cosmos DB" >> $GITHUB_STEP_SUMMARY
          echo "- Redis-free architecture" >> $GITHUB_STEP_SUMMARY
          echo "- **Estimated Monthly Cost**: $45-65" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎯 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Deploy applications using main CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify endpoints are operational" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor costs in Azure portal" >> $GITHUB_STEP_SUMMARY
